version: "3.9"

x-common-env: &common_env
  TZ: "UTC"

services:
  traefik:
    image: traefik:v3.1
    command:
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --providers.docker=true
      - --providers.docker.network=edge
      - --providers.docker.exposedbydefault=false
      - --api.insecure=true
      - --log.level=DEBUG
    ports:
      - "80:80"
      - "443:443"
      - "8084:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    networks:
      - edge
      - lexnet

  comfy-sd:
    build:
      context: ./docker/comfyui
    image: local/comfyui:plain
    container_name: comfy-sd
    restart: unless-stopped
    environment:
      - NVIDIA_VISIBLE_DEVICES=4,5
      - NVIDIA_DRIVER_CAPABILITIES=all
      - CLI_ARGS=--listen 0.0.0.0 --port 8188 --enable-cors-header=https://lexicompanion.com --enable-cors-header=http://localhost:3000 --max-upload-size=2000
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 2
              capabilities: [gpu]
    volumes:
      - /mnt/data/comfy/input:/app/ComfyUI/input
      - /mnt/data/comfy/output:/app/ComfyUI/output
      - /mnt/data/comfy/models:/app/ComfyUI/models
      - /mnt/data/comfy/custom_nodes:/app/ComfyUI/custom_nodes
      - /mnt/data/comfy/extra_model_paths.yaml:/app/ComfyUI/extra_model_paths.yaml:ro
      - /mnt/data/Lex/assets/default.png:/app/ComfyUI/input/default.png:ro
    healthcheck:
      test: ["CMD", "bash", "-lc", "curl -sf http://127.0.0.1:8188/ || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 20
    networks:
      - lexnet

  lexi-backend:
    build:
      context: .
      dockerfile: docker/lexi-backend/Dockerfile
    image: lexi-backend:alpha
    env_file:
      - .env.development
    environment:
      <<: *common_env
      LLM_API_BASE: ${LLM_API_BASE:-http://host.docker.internal:8008/v1}
      OPENAI_API_BASE: ${OPENAI_API_BASE:-http://host.docker.internal:8008/v1}
      SUMMARIZER_ENDPOINT: ${SUMMARIZER_ENDPOINT:-http://host.docker.internal:8008/v1/chat/completions}
      COMFY_URL: ${COMFY_URL:-http://comfy-sd:8188}
      COMFY_BASE_URL: ${COMFY_BASE_URL:-http://comfy-sd:8188}
      IMAGE_API_BASE: ${IMAGE_API_BASE:-http://comfy-sd:8188}
      LEX_SDXL_CHECKPOINT: ${LEX_SDXL_CHECKPOINT:-flux1-kontext-dev.safetensors}
      LEX_VAE: ${LEX_VAE:-ae.safetensors}
      LEX_CLIP: ${LEX_CLIP:-clip_l.safetensors}
      LEX_T5: ${LEX_T5:-t5xxl_fp8_e4m3fn.safetensors}
      LEXI_PERSONA_API_BASE: ${LEXI_PERSONA_API_BASE:-http://host.docker.internal:8008/v1}
      LEXI_PERSONA_TIMEOUT: ${LEXI_PERSONA_TIMEOUT:-10}
      LEX_SKIP_MODEL_PREFLIGHT: ${LEX_SKIP_MODEL_PREFLIGHT:-1}
      LEX_AVATAR_DIR: ${LEX_AVATAR_DIR:-/app/static/avatars}
      LEX_PUBLIC_BASE: ${LEX_PUBLIC_BASE:-}
      CORS_ORIGINS: ${CORS_ORIGINS:-https://lexicompanion.com}
    ports:
      - "${API_PORT:-9000}:9000"
    expose:
      - "9000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - comfy-sd
    volumes:
      - ./Lexi:/app/Lexi
      - ./data:/data
      - ./logs/sessions:/app/logs/sessions
      - hf_cache:/data/hf_cache
    command: >
      python3 -m uvicorn lexi.core.backend_core:app
      --host 0.0.0.0
      --port 9000
      --proxy-headers
    restart: unless-stopped
    networks: [lexnet]

  lexi-frontend:
    build:
      context: .
      dockerfile: docker/lexi-frontend/Dockerfile
    image: lexi-frontend:alpha
    env_file:
      - .env.development
    environment:
      <<: *common_env
    depends_on:
      - lexi-backend
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    expose:
      - "80"
    restart: unless-stopped
    networks: [lexnet]

  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel run
    volumes:
      - ./cloudflared:/etc/cloudflared
    depends_on:
      - lexi-frontend
      - lexi-backend
    restart: unless-stopped
    networks: [lexnet]

volumes:
  hf_cache:

networks:
  edge:
    external: true
  lexnet:
    driver: bridge
